!function(){"use strict";const t=()=>{let t=window.Shopify?.shop;return t},e=async e=>{const n=t();if(n){const t=await(async(t,e)=>{try{const e=await fetch(`/apps/chatbot-api/supabase?shopId=${encodeURIComponent(t)}`,{method:"GET",credentials:"same-origin",headers:{Accept:"application/json"}});if(!e.ok)throw new Error(`Server responded with status: ${e.status}`);return(await e.json()).color}catch(t){return console.error("Error fetching the color preference!",t),e}})(n,e);t&&(t=>{document.querySelectorAll(".chatbot-toggle-button, .chatbot-header, .send-button").forEach((e=>{e.style.backgroundColor=t})),document.querySelectorAll(".chatbot-window").forEach((e=>{e.style.borderColor=t})),document.querySelectorAll(".typing-indicator span").forEach((e=>{e.style.backgroundColor=t}))})(t)}};let n=[],o=null,a=!1;function c(){const t=n.reduce(((t,e)=>t+e.quantity),0);document.querySelectorAll(".cart-count").forEach((e=>{e.textContent=t,e.style.display=t>0?"flex":"none"}))}function r(){const t=n.map((t=>({id:t.variant_id,quantity:t.quantity})));fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({items:t})}).then((t=>t.json())).then((t=>{console.log("Cart updated:",t)})).catch((t=>{console.error("Error updating cart:",t)}))}function s(){const t=document.querySelector(".cart-drawer");t&&(t.classList.remove("open"),t.classList.add("auto-close"))}function i(){if(a)return;const t=document.querySelector(".chatbot-window"),e=document.querySelector(".cart-drawer");if(t&&!e){const e=function(){const t=document.createElement("div");t.className="cart-drawer";const e=document.createElement("div");e.className="cart-drawer-header";const n=document.createElement("h3");n.className="cart-drawer-title",n.textContent="Added to Cart";const o=document.createElement("button");o.className="cart-drawer-close",o.innerHTML="&times;",o.addEventListener("click",s),e.appendChild(n),e.appendChild(o);const a=document.createElement("div");a.className="cart-drawer-content";const c=document.createElement("a");return c.className="checkout-button",c.textContent="CHECKOUT",c.href="/checkout",t.appendChild(e),t.appendChild(a),t.appendChild(c),d(),t}();t.appendChild(e),a=!0,c()}}function d(){const t=document.querySelector(".cart-drawer-content");if(t){if(t.innerHTML="",0===n.length){const e=document.createElement("p");return e.textContent="Your cart is empty",void t.appendChild(e)}n.forEach((e=>{const n=document.createElement("div");n.className="cart-item";const o=document.createElement("img");o.className="cart-item-image",o.src=e.image,o.alt=e.title;const a=document.createElement("div");a.className="cart-item-details";const c=document.createElement("h4");c.className="cart-item-title",c.textContent=e.title;const r=document.createElement("p");r.className="cart-item-price",r.textContent=e.price;const s=document.createElement("div");s.className="cart-item-actions";const i=document.createElement("div");i.className="quantity-selector";const d=document.createElement("button");d.className="quantity-btn",d.textContent="-",d.addEventListener("click",(()=>l(e,-1)));const u=document.createElement("input");u.className="quantity-input",u.type="text",u.value=e.quantity,u.readOnly=!0;const p=document.createElement("button");p.className="quantity-btn",p.textContent="+",p.addEventListener("click",(()=>l(e,1))),i.appendChild(d),i.appendChild(u),i.appendChild(p),s.appendChild(i),a.appendChild(c),a.appendChild(r),a.appendChild(s),n.appendChild(o),n.appendChild(a),t.appendChild(n)}))}}function l(t,e){t.quantity+=e,t.quantity<1&&(n=n.filter((e=>e.id!==t.id))),d(),r(),c();const a=document.querySelector(".cart-drawer");a&&(a.classList.remove("auto-close"),o&&clearTimeout(o),o=setTimeout((()=>{a.classList.add("auto-close")}),5e3))}function u(t,e){const a=document.createElement("div");return a.className="product-slider",t.slice(0,4).forEach((t=>{const s=document.createElement("div");s.className="product-card";const l=document.createElement("img");l.src=t.image,l.alt=t.title,l.className="product-image";const u=document.createElement("div");u.className="product-title",u.textContent=t.title;const p=document.createElement("div");p.className="product-price",p.textContent=t.price;const m=document.createElement("a");m.href=t.url,m.target="_blank",m.rel="noopener noreferrer",m.className="view-product-button",m.textContent="View Product",m.style.backgroundColor=e;const h=document.createElement("button");h.className="add-to-cart-button",h.textContent="ADD TO CART",h.style.backgroundColor=e||"#000",h.dataset.productId=t.id,h.dataset.productVariantId=t.variant_id||t.id,h.dataset.productTitle=t.title,h.dataset.productPrice=t.price,h.dataset.productImage=t.image,h.addEventListener("click",(e=>{e.preventDefault(),function(t){const e=n.find((e=>e.id===t.id));e?e.quantity+=1:n.push({id:t.id,variant_id:t.variant_id||t.id,title:t.title,price:t.price,image:t.image,quantity:1}),d(),r(),c();const o=new Event("productAddedToCart");document.dispatchEvent(o)}(t),function(){let t=document.querySelector(".cart-drawer");t||(i(),t=document.querySelector(".cart-drawer"),t)?(t.classList.add("open"),t.classList.remove("auto-close"),o&&clearTimeout(o),o=setTimeout((()=>{t.classList.add("auto-close")}),5e3)):console.error("Failed to initialize cart drawer")}(),h.textContent="ADDED TO CART",h.classList.add("added"),setTimeout((()=>{h.textContent="ADD TO CART",h.classList.remove("added")}),3e3)})),s.appendChild(l),s.appendChild(u),s.appendChild(p),s.appendChild(m),s.appendChild(h),a.appendChild(s)})),a}function p(t,e,n=[],o){const a=document.querySelector(".message-list"),c=document.createElement("div");c.className="message-wrapper";const r=document.createElement("div");if(r.className=`message ${e}-message`,r.textContent=t,r.style.backgroundColor="#40444b",r.style.borderColor="#40444b",c.appendChild(r),n&&n.length>0){const t=u(n,o);c.appendChild(t)}a.appendChild(c),function(){const t=document.querySelector(".chat-window");t.scrollTop=t.scrollHeight}()}function m(e,n,o){const a=t(),c=new Headers({"Content-Type":"application/json",Accept:"application/json"});fetch("/apps/chatbot-api/deepseek",{method:"POST",headers:c,body:JSON.stringify({messages:[{role:"user",content:e}],namespace:a})}).then((t=>t.ok?t.json():t.json().then((e=>{throw new Error(`Server error: ${t.status} - ${JSON.stringify(e)}`)})))).then((t=>{n&&n.remove(),t&&t.answer?p(t.answer,"bot",t.products||[],o):p("Sorry, I couldn't process your request.","bot",[],o)})).catch((t=>{n&&n.remove(),p("Sorry, there was an error processing your request. Please try again later.","bot",[],o),console.error("Error:",t)}))}function h(){return JSON.parse(localStorage.getItem("chatbotUserData"))||{}}function y(){return JSON.parse(sessionStorage.getItem("chatbotSessionData"))||{}}function f(){return!!h().email}function b(t){return function(t){const e={...y(),...t};return sessionStorage.setItem("chatbotSessionData",JSON.stringify(e)),e}({[`session_${t}`]:(y()[`session_${t}`]||0)+1,last_interaction:(new Date).toISOString()})}function g(){window.addEventListener("load",(()=>{document.addEventListener("productAddedToCart",(()=>{b("products_added_to_cart")})),document.addEventListener("productPurchased",(()=>{b("products_purchased")}))})),window.addEventListener("beforeunload",(()=>{const t=function(){const t=y();if(!t.email)return;const e={...t,session_end:(new Date).toISOString(),total_chat_interactions:t.session_chat_interactions||0,total_products_added_to_cart:t.session_products_added_to_cart||0,total_products_purchased:t.session_products_purchased||0};return localStorage.setItem("chatbotUserData",JSON.stringify({email:t.email,first_interaction:t.first_interaction||(new Date).toISOString(),last_interaction:e.session_end})),sessionStorage.removeItem("chatbotSessionData"),e}();if(t){const e=new Blob([JSON.stringify(t)],{type:"application/json"});navigator.sendBeacon("/apps/chatbot-api/store-session",e)}}))}function C(t){const e=document.querySelector(".input-box"),n=document.querySelector(".send-button"),o=document.querySelector(".message-list");function a(){const t=e.value.trim();if(""===t)return;c(t,"user"),b("chat_interactions"),e.value="",n.disabled=!0;const a=document.createElement("div");a.className="typing-indicator",a.innerHTML="<span></span><span></span><span></span>",a.style.backgroundColor="#40444b",a.style.borderColor="#40444b",o.appendChild(a),r(),m(t,a)}function c(t,e){const n=document.createElement("div");n.className=`message ${e}-message`,n.textContent=t,o.appendChild(n),r()}function r(){const t=document.querySelector(".chat-window");t.scrollTop=t.scrollHeight}return e.addEventListener("input",(()=>{n.disabled=""===e.value.trim()})),n.addEventListener("click",(()=>a())),e.addEventListener("keypress",(t=>{"Enter"===t.key&&""!==e.value.trim()&&(t.preventDefault(),a())})),setTimeout((()=>{c("Hi there! How can I help you today?","bot")}),500),{fetchBotResponse:m}}function v(t,e,n,o){t.querySelector(".start-chat-button").addEventListener("click",(async()=>{const o=t.querySelector(".email-input").value.trim();if(o&&function(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}(o))try{const a=await async function(){try{const t=await fetch("https://api.ipify.org?format=json");return await t.json()}catch(t){return console.error("Error fetching IP:",t),{ip:"unknown"}}}(),c=(await async function(t){if("unknown"===t)return{country:"unknown",city:"unknown"};try{const e=await fetch(`https://ipapi.co/${t}/json/`),n=await e.json();return{country:n.country_name||"unknown",city:n.city||"unknown",region:n.region||"unknown"}}catch(t){return console.error("Error fetching location:",t),{country:"unknown",city:"unknown"}}}(a.ip),function(t){const e={...h(),email:t,session_start:(new Date).toISOString(),session_chat_interactions:0,session_products_added_to_cart:0,session_products_purchased:0};return sessionStorage.setItem("chatbotSessionData",JSON.stringify(e)),e}(o,a.ip));localStorage.setItem("chatbotUserData",JSON.stringify({email:o,first_interaction:c.first_interaction||(new Date).toISOString()})),t.classList.remove("open"),e.classList.add("open"),n.innerHTML="×",document.querySelector(".input-box").focus(),C(),b("chat_interactions")}catch(t){console.error("Error collecting user data:",t),alert("Failed to start chat. Please try again.")}else alert("Please enter a valid email address")}))}document.addEventListener("DOMContentLoaded",(function(){try{const t=document.getElementById("shopify-chatbot");if(!t)return;const n="#008080",o="#f8f8f8",a="Store Assistant";t.style.setProperty("--primary-color",n),t.style.setProperty("--text-color",o);const c=function(t){const e=document.createElement("button");return e.className="chatbot-toggle-button",e.innerHTML="💬",e.style.backgroundColor=t,e}(n);t.appendChild(c);const r=function(t,e){const n=document.createElement("div");return n.className="email-collection-screen",n.style.borderColor=t,n.innerHTML=`\n        <div class="chatbot-header" style="background-color: ${t}">\n            <h3 class="chatbot-header-title">${e}</h3>\n            <button class="chatbot-close-button">✕</button>\n        </div>\n        <div class="email-collection-content">\n            <p>Please enter your email to start chatting</p>\n            <input type="email" class="email-input" placeholder="Your email address" required>\n            <button class="start-chat-button" style="background-color: ${t}">Start Chat</button>\n        </div>\n    `,n}(n,a);t.appendChild(r);const s=function(t,e){const n=document.createElement("div");n.className="chatbot-window",n.style.borderColor=t;const o=document.createElement("div");o.className="chatbot-header",o.style.backgroundColor=t;const a=document.createElement("h3");a.className="chatbot-header-title",a.textContent=e;const c=document.createElement("button");c.className="chatbot-close-button",c.innerHTML="✕";const r=document.createElement("div");r.className="chatbot-cart-icon",r.innerHTML='\n      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n        <circle cx="9" cy="21" r="1"></circle>\n        <circle cx="20" cy="21" r="1"></circle>\n        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>\n      </svg>\n      <span class="cart-count">0</span>\n    ',r.addEventListener("click",(()=>{window.location.href="/cart"})),o.appendChild(a),o.appendChild(r),o.appendChild(c),n.appendChild(o);const s=document.createElement("div");s.className="chat-window";const i=document.createElement("div");i.className="message-list",s.appendChild(i),n.appendChild(s);const d=document.createElement("div");return d.className="input-component",d.innerHTML=`\n      <input type="text" class="input-box" placeholder="Type your message...">\n      <button class="send-button" disabled style="background-color: ${t};">\n        Send\n      </button>\n    `,n.appendChild(d),n}(n,a);t.appendChild(s),i(),f()&&C(),function(t,e,n){t.addEventListener("click",(()=>{f()?(n.classList.toggle("open"),n.classList.contains("open")?(t.innerHTML="×",document.querySelector(".input-box").focus()):t.innerHTML="💬"):(e.classList.toggle("open"),e.classList.contains("open")?(t.innerHTML="×",e.querySelector(".email-input").focus()):t.innerHTML="💬")}))}(c,r,s),v(r,s,c),function(t,e,n){t.querySelector(".chatbot-close-button").addEventListener("click",(()=>{t.classList.remove("open"),n.innerHTML="💬"})),e.querySelector(".chatbot-close-button").addEventListener("click",(()=>{e.classList.remove("open"),n.innerHTML="💬"}))}(r,s,c),e(n),g()}catch(t){console.error("Initialization error:",t)}}))}();
